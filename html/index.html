<!DOCTYPE html>

<html>
    <head>
        <title>TODO APP</title>
		<style>
			#content{
						
			}
			span{				
				display: inline-block;
			}
			#actions{
				width: 40%;				
			}
			#todos{
				width: 30%;				
			}
			button, input, label, textarea{								
				margin: 10px;
				padding: 5px;
				width: 150px;
			}
			button, label{
				display: block;
			}
			button:hover{
				background-color: indianred;
				color: white;
				
			}
			textarea{
				width: 350px;
			}
			input{
				text-align: center;
			}

			#form span{
				display: inline-block;
				width: 100px;
				color: darkblue;
				margin: 10px;
			}

			#todos{
				vertical-align: top;
			}	
			#todos .name{
				font-size: 1em;
			}		
			[class*=priority-]{
				color: white;
				text-align: center;
				margin-top: 2px;
			}
			.priority-1-todo{
				background-color: indianred;
				
			}
			.priority-2-todo{
				background-color: orange;
				
			}
			.priority-3-todo{
				background-color: lightblue;				
			}

		</style>
    </head>

    <body>
        <h2>Welcome to TODO APP</h2>
		<div id="content">
			<span id="actions">
				
				<div id="form">
					<div>
						<span>Id</span>
						<input type="number" id="todoId" />
					</div>
					<div>
						<span>Name</span>
						<input type="text" id="todoName" />
					</div>
					<div>
						<span>Description</span>
						<input type="text" id="todoDescription" />
					</div>
					<div>
						<span>Project</span>
						<input type="text" id="todoProject" />
					</div>
					<div>
						<span>Date</span>
						<input type="date" id="todoDate" />
					</div>
					<div>
						<span>Time</span>
						<input type="time" id="todoTime" />
					</div>
					<div>
						<span>Priority</span>
						<select id="todoPriority">
							<option value="1">HIGH</option>
							<option value="2">MEDIUM</option>
							<option value="3">LOW</option>
						</select>
					</div>
				</div>
				
			
				<button id="getAllTodos">GET ALL</button>
				<button id="getTodo">GET</button>
				<button id="createTodo">CREATE</button>
				<button id="updateTodo">UPDATE</button>
				<button id="deleteTodo">DELETE</button>
				<button id="deleteAllTodos">DELETE ALL</button>
			</span>
			
			<span id="todos">
				
			</span>					
		</div>
    </body>

    <script>			
		const prettify = json => JSON.stringify(json, null, 2);
		const logJson = json => console.log(prettify(json));
		
		const selectById = id => document.getElementById(id);
		const selectAll = cssSelector => [].slice.call(document.querySelectorAll(cssSelector));	
		const setText = (id, text) => selectById(id).innerHTML = text;
		
		
		selectById('todoId').value = 0;	


		const rest = async (url, options) => {
			const response = await fetch(url, options);
			return await response.json();
		}

		const createTodoHtml = todoJson => {
			const todoClass = todoJson.priority == 1 ? 'priority-1-todo' 
				:  todoJson.priority == 2 ? 'priority-2-todo'
				: 'priority-3-todo';

			return '<div class="' + todoClass + '">'
				+ '<div class="title"' + todoJson.name + '</div>'
				+ '<div class="description">' + todoJson.description + '</div>'
				+ '<div class="date">' + todoJson.date + todoJson.time + '</div>'
				+ '<div class="priority">' + todoJson.priority + '</div>'
				+ '</div>';
		}

		const getTodoJson = () => {
			const todoJson = selectAll('#form input').reduce(
				(acc, input) => {
					// id = todoName => key = name
					const key = input.id.replace('todo','').toLowerCase();
					acc[key] = [ 'id', 'priority' ].includes(key) ?
						parseInt(input.value) :
						input.value;

					return acc;
				}, 
				{}
			);
			return JSON.stringify(todoJson);	
		};

		const resetTodos = () => selectById('todos').innerHTML = '';
			
		const apiUrl = 'https://go-gin-todo.herokuapp.com/api/todo';
		//const apiUrl = 'http://localhost:3000/api/todo';
		const actions = {
					
			getAllTodos: async () => {
				const responseJson =  await rest(apiUrl);							
				resetTodos();

				responseJson.data.map(createTodoHtml)
					.forEach(todoHtml => todos.innerHTML = todos.innerHTML + todoHtml);

				return responseJson.data;
			},
		
			getTodo: async todoId => {
				const responseJson =  await rest(apiUrl + '/' + todoId);			
				
				return responseJson.data;
			},
			
			createTodo: async todoJson => {
				console.log('body:  ' + getTodoJson());
				const responseJson =  await rest(
					apiUrl,
					{
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: getTodoJson()
					}
				);			
				actions.getAllTodos();
				return responseJson.data;
			},
			
			updateTodo: async (todoId, todoJson) => {				
				const responseJson =  await rest(
					apiUrl + '/' + todoId,
					{
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: getTodoJson()						 
					}
				);							
				actions.getAllTodos();
				return responseJson.data;
			},
			
			deleteTodo: async todoId => {
				const responseJson =  await rest(
					apiUrl + '/' + todoId, 
					{ method: 'DELETE' }
				);							
				actions.getAllTodos();
				return responseJson;
			},
			
			deleteAllTodos: async () => {
				const responseJson =  await rest(
					apiUrl + '/reset',
					{ method: 'POST' }
				);							
				resetTodos();
				return responseJson;
			}		
		};
		
		const addTodoActionToButton = buttonElement => { 
			console.log(todo[button.id]);
			buttonElement.addEventListener('click', todo[button.id]);
		}
			
		const getTodoJsonBody = () => JSON.parse(selectById('todoBody').value);
		const getTodoId = () => selectById('todoId').value;
		

		const buttonsClickEventHandlers = {
			getAllTodos: actions.getAllTodos,
			getTodo: () => actions.getTodo(getTodoId()),
			createTodo: () => actions.createTodo(getTodoJson()),
			updateTodo: () => actions.updateTodo(getTodoId(), getTodoJson()),
			deleteTodo: () => actions.deleteTodo(getTodoId()),
			deleteAllTodos: actions.deleteAllTodos
		}
			
		const bindButtonsActionClickHandlers = () => selectAll('#actions button')
			.forEach(button => button.addEventListener(
				'click', 
				buttonsClickEventHandlers[button.id]
			)				
		);
		
		bindButtonsActionClickHandlers();
		
    </script>

</html>
